---
- name: Enhanced K3s Deployment with Monitoring
  hosts: all_nodes
  become: yes
  tasks:
    - name: Ensure dependencies are installed (Ubuntu)
      apt:
        name: 
          - curl
          - procps
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure dependencies are installed (Rocky/RHEL)
      dnf:
        name: 
          - curl
          - procps-ng
        state: present
      when: ansible_os_family == "RedHat"

- name: Install K3s Master
  hosts: k3s_master
  become: yes
  tasks:
    - name: Install K3s Binaries
      shell: curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true INSTALL_K3S_SKIP_ENABLE=true sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Start K3s Server
      shell: |
        if ! pgrep -f "k3s server" > /dev/null; then
          nohup k3s server --https-listen-port 6443 --write-kubeconfig-mode 644 > /var/log/k3s.log 2>&1 &
        fi

    - name: Wait for K3s to be ready
      wait_for:
        port: 6443
        delay: 5
        timeout: 60

    - name: Get K3s Node Token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token_base64

    - name: Store Token
      set_fact:
        k3s_token: "{{ node_token_base64['content'] | b64decode | trim }}"

    - name: Copy kubeconfig to ansible user
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/ansible/.kube/config
        owner: ansible
        group: ansible
        mode: '0600'
        remote_src: yes

    - name: Create .kube directory
      file:
        path: /home/ansible/.kube
        state: directory
        owner: ansible
        group: ansible

- name: Install K3s Workers
  hosts: k3s_workers
  become: yes
  vars:
    master_url: "https://ubuntu1:6443"
    token: "{{ hostvars[groups['k3s_master'][0]]['k3s_token'] }}"
  tasks:
    - name: Install K3s Agent Binaries
      shell: "curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true INSTALL_K3S_SKIP_ENABLE=true K3S_URL={{ master_url }} K3S_TOKEN={{ token }} sh -"
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Start K3s Agent
      shell: |
        if ! pgrep -f "k3s agent" > /dev/null; then
          nohup k3s agent --server {{ master_url }} --token {{ token }} > /var/log/k3s-agent.log 2>&1 &
        fi

    - name: Wait for agent to connect
      pause:
        seconds: 10

- name: Verify K3s Cluster
  hosts: k3s_master
  become: yes
  tasks:
    - name: Get cluster nodes
      shell: kubectl get nodes
      register: nodes_output

    - name: Display cluster status
      debug:
        msg: "{{ nodes_output.stdout_lines }}"
