---
- name: Demonstrate HashiCorp Vault Secret Management
  hosts: localhost
  gather_facts: no
  vars:
    vault_addr: "http://vault:8200"
    vault_token: "devopslab-root-token"
  tasks:
    - name: Wait for Vault to be ready
      uri:
        url: "{{ vault_addr }}/v1/sys/health"
        status_code: [200, 429, 473, 501, 503]
      register: vault_health
      until: vault_health.status in [200, 429, 473]
      retries: 30
      delay: 5

    - name: Enable KV secrets engine
      uri:
        url: "{{ vault_addr }}/v1/sys/mounts/secret"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          type: "kv-v2"
        status_code: [200, 204, 400]
      register: kv_enable

    - name: Write sample database credentials to Vault
      uri:
        url: "{{ vault_addr }}/v1/secret/data/database/postgres"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          data:
            username: "dbadmin"
            password: "super-secret-password"
            host: "postgres.internal"
            port: 5432
        status_code: [200, 204]

    - name: Write sample API keys to Vault
      uri:
        url: "{{ vault_addr }}/v1/secret/data/api/production"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          data:
            api_key: "sk-1234567890abcdef"
            api_secret: "secret-key-12345"
        status_code: [200, 204]

    - name: Read secret from Vault
      uri:
        url: "{{ vault_addr }}/v1/secret/data/database/postgres"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        return_content: yes
      register: vault_secret

    - name: Display secret (for demo purposes only!)
      debug:
        msg: |
          Secret retrieved from Vault:
          Username: {{ vault_secret.json.data.data.username }}
          Host: {{ vault_secret.json.data.data.host }}
          (Password hidden in production use)

    - name: Display Vault information
      debug:
        msg: |
          Vault is running at {{ vault_addr }}
          Root token: {{ vault_token }}
          Secrets stored in /secret/ path
